"use strict";var currentCrateObj,currentCrate=0,save={options:{}};importScripts("../data/crate.js");var wearTable=["","FN","MW","FT","WW","BS"],wearTableNames=["",80,81,82,83,84],gradeTable=["","colorcivilian","colorfreelance","colormercenary","colorcommando","colorassassin","colorelite"],sheenTable=["",128,129,130,131,132,133,134],killstreakerTable=["",135,136,137,138,139,140,141];function crateHasRandomStranges(e){var a=!1,r=!0,t=!1,s=void 0;try{for(var n,u=e.loot[Symbol.iterator]();!(r=(n=u.next()).done);r=!0){var o=n.value;if([4,6,8,9,10].includes(o.quality)){a=!0;break}}}catch(e){t=!0,s=e}finally{try{r||null==u.return||u.return()}finally{if(t)throw s}}return a}function getString(e,a){return null}function reportError(e){self.postMessage({error:e})}function unbox(){var r,a,t,e,s,n,u=[];try{var o,l,c=currentCrateObj,i=Math.floor(1e4*Math.random()+1),h=Math.floor(150*Math.random()+1),d=0;c.unusual&&(1===h||save.options.forceUnusual)?(l=[],function(){switch(c.unusual){case 1:l=unusualPool.slice(),96===currentCrate&&save.options.eotlGlitch&&l.push(916,917,918),1<=currentCrateObj.series&&currentCrateObj.series<=55&&save.options.sniperVsSpyUnusuals&&l.push(1354,1359,1370,62,158,194,124,70,178),r=l[Math.floor(Math.random()*l.length)],o={id:r,quality:null};break;case 2:for(var a=save.options.forceGrade?save.options.forceGradeNum:(a=Math.floor(1e3*Math.random()+1))<=8?6:a<=40?5:a<=200?4:3;0===l.length;){if(l=c.loot.filter(function(e){return[6,7,9,10].includes(e.quality)&&e.grade==a}),a<=2)throw new Error;a--}o=l[Math.floor(Math.random()*l.length)],r=o.id;break;case 3:l=c.loot.filter(function(e){return[6,7,9,10].includes(e.quality)}),o=l[Math.floor(Math.random()*l.length)],r=o.id}}(),u.push("unusual")):function(){switch(c.autoChance){case 1:var a;save.options.forceGrade?a=save.options.forceGradeNum:(a=(a=Math.floor(1e3*Math.random()+1))<=8?6:a<=40?5:a<=200?4:3,1===c.loot[0].grade&&(a-=2));for(var e=[];0===e.length;){if(e=c.loot.filter(function(e){return e.grade==a}),a<=0)throw new Error;a--}var r=Math.floor(Math.random()*e.length);o=e[r],n=c.loot.findIndex(function(e){return e.id==o.id});break;case 2:var t=Math.floor(Math.random()*c.loot.length);o=c.loot[t],n=t;break;default:for(var s in i=Math.floor(9900*Math.random()+1),c.loot){if(d<i&&i<=d+c.loot[s].chance){o=c.loot[s],n=s;break}d+=c.loot[s].chance}}}(),r=o.id;var f,b,v,k,y,g,m=!1;if(null!=o.quality)switch(o.quality){case 0:u.push("unusual");break;case 1:case 7:u.push("unique");break;case 2:u.push("strange");break;case 3:u.push("haunted");break;case 4:case 9:case 10:10==(f=Math.floor(10*Math.random()+1))||save.options.forceStrange?u.push("strange"):u.push("unique");break;case 5:m=!0;break;case 6:m=!0,10!=(f=Math.floor(10*Math.random()+1))&&!save.options.forceStrange||u.push("strange");break;case 8:10==(f=Math.floor(10*Math.random()+1))||save.options.forceStrange?u.push("strange","haunted"):u.push("unique");break;case 11:u.push("unique"),e={sheen:null,killstreaker:null},(65<(f=Math.floor(100*Math.random()+1))||save.options.forceProKit)&&(e.sheen=Math.floor(Math.random()*(sheenTable.length-1)+1)),(90<f||save.options.forceProKit)&&(e.killstreaker=Math.floor(Math.random()*(killstreakerTable.length-1)+1));break;case 12:u.push("strangifier")}if(u=1===u.length?u[0]:u.join(""),a=0,m)switch(Math.floor(10*Math.random()+1)){case 1:a=1;break;case 2:case 3:a=2;break;case 4:case 5:case 6:case 7:a=3;break;case 8:case 9:a=4;break;case 10:a=5}if(t=0,u.includes("unusual")){if(!["none",null,void 0].includes(save.options.halloweenMode)&&halloweenModeCrateList[save.options.halloweenMode].includes(currentCrate))switch(save.options.halloweenMode){case"hw11":b=hw11FX;break;case"hw12":b=hw12FX;break;case"hw13":b=hw13FX;break;case"hw14":b=hw14FX;break;case"hw16":b=hw16FX;break;case"hw17":b=hw17FX;break;case"hw18":b=hw18FX;break;case"hw19":b=hw19FX;break;case"hw20":b=hw20FX;break;case"xmas19":b=xmas19FX;break;case"xmas20":b=xmas20FX}else b=c.effects;t=b[Math.floor(Math.random()*b.length)]}if(s=[],c.bonus){var p=0;save.options.forceBonusItem?p=3:(p=0,(Math.floor(5*Math.random()+1)<=2||save.options.forceBonusItem)&&(p++,1==Math.floor(5*Math.random()+1)&&(p++,1==Math.floor(25*Math.random()+1)&&p++)));for(var x=!1;0<p;p--){if(Math.floor(1e3*Math.random()+1)<=15||save.options.forceUnusualifier){var M=Math.floor(Math.random()*unusualifierArray.length);s.push({id:770,taunt:unusualifierArray[M]})}else{var w=!1;if(c.exclusiveBonus&&!x&&Math.floor(1e4*Math.random()+1)<=c.exclusiveBonus.chance&&(w=!0,c.oneExclusiveBonus&&(x=!0)),w){var C=Math.floor(Math.random()*c.exclusiveBonus.loot.length);s.push({id:c.exclusiveBonus.loot[C]})}else{var O=Math.floor(Math.random()*globalBonusItemArray.length);switch(globalBonusItemArray[O]){case"paint":s.push({id:paintBonusArray[Math.floor(Math.random()*paintBonusArray.length)]});break;case"strangepart":s.push({id:strangePartBonusArray[Math.floor(Math.random()*strangePartBonusArray.length)]});break;default:s.push({id:globalBonusItemArray[O]})}}}}}else{c.exclusiveBonus&&(Math.floor(1e4*Math.random()+1)<=c.exclusiveBonus.chance||save.options.forceBonusItem)&&(v=Math.floor(Math.random()*c.exclusiveBonus.loot.length),s.push({id:c.exclusiveBonus.loot[v]}))}return c.creepyBonus&&(1!==Math.floor(50*Math.random()+1)&&!save.options.forceBonusItem||(k=Math.floor(Math.random()*creepyCrateBonusArray.length),11===creepyCrateBonusArray[k].quality&&(y={sheen:null,killstreaker:null},(65<(g=Math.floor(100*Math.random()+1))||save.options.forceProKit)&&(y.sheen=Math.floor(Math.random()*(sheenTable.length-1)+1)),(90<g||save.options.forceProKit)&&(y.killstreaker=Math.floor(Math.random()*(killstreakerTable.length-1)+1))),s.push({id:creepyCrateBonusArray[k].id,quality:creepyCrateBonusArray[k].quality,killstreak:y}))),{id:r,cratePos:n,name:getString("item",r),quality:u,wear:a,grade:o.grade,effect:t,killstreak:e,bonus:s}}catch(e){var S="Something went wrong when executing unbox().\n    Error stack: ".concat(e.stack,"\n\n    currentCrate: ").concat(currentCrate,"\n    randomNumber: ").concat(i,"\n    unusualRandomNumber: ").concat(h,"\n    forceUnusual: ").concat(save.options.forceUnusual,"\n    itemId: ").concat(r,"\n    quality: ").concat(u,"\n    wear: ").concat(a,"\n    effect: ").concat(t);console.error(S),reportError(S)}}function addToInventory(e,w,a){var r;if(null!=e.cratePos)switch(currentCrateObj.loot[e.cratePos].quality){case 4:case 8:case 9:case 10:r=["strange","strangehaunted"].includes(e.quality)?w.crates[crateOrder[currentCrate]][e.cratePos].q+=1:w.crates[crateOrder[currentCrate]][e.cratePos].n+=1;break;case 5:r=w.crates[crateOrder[currentCrate]][e.cratePos][wearTable[e.wear]]+=1;break;case 6:r="strange"===e.quality?w.crates[crateOrder[currentCrate]][e.cratePos]["".concat(wearTable[e.wear],"q")]+=1:w.crates[crateOrder[currentCrate]][e.cratePos][wearTable[e.wear]]+=1;break;case 11:var t=!1;if(e.killstreak.killstreaker){var s=!0,n=!1,u=void 0;try{for(var o,l=w.crates[crateOrder[currentCrate]][e.cratePos].p[Symbol.iterator]();!(s=(o=l.next()).done);s=!0){var c=o.value;if(c.s===e.killstreak.sheen&&c.p===e.killstreak.killstreaker){r=c.n+=1,t=!0;break}}}catch(e){n=!0,u=e}finally{try{s||null==l.return||l.return()}finally{if(n)throw u}}t||(r=1,w.crates[crateOrder[currentCrate]][e.cratePos].p.push({n:1,s:e.killstreak.sheen,k:e.killstreak.killstreaker}))}else if(e.killstreak.sheen){var i=!0,h=!1,d=void 0;try{for(var f,b=w.crates[crateOrder[currentCrate]][e.cratePos].s[Symbol.iterator]();!(i=(f=b.next()).done);i=!0){var v=f.value;if(v.s===e.killstreak.sheen){r=v.n+=1,t=!0;break}}}catch(e){h=!0,d=e}finally{try{i||null==b.return||b.return()}finally{if(h)throw d}}t||(r=1,w.crates[crateOrder[currentCrate]][e.cratePos].s.push({n:1,s:e.killstreak.sheen}))}else r=w.crates[crateOrder[currentCrate]][e.cratePos].n+=1;break;default:r=w.crates[crateOrder[currentCrate]][e.cratePos].n+=1}var k=!0,y=!1,g=void 0;try{for(var C,m=e.bonus[Symbol.iterator]();!(k=(C=m.next()).done);k=!0)!function(){var a=C.value;if(null!=currentCrateObj.exclusiveBonus.loot&&currentCrateObj.exclusiveBonus.loot.includes(a.id))w.crates[crateOrder[currentCrate]][currentCrateObj.loot.length+currentCrateObj.exclusiveBonus.loot.findIndex(function(e){return e===a.id})].n++;else if(currentCrateObj.creepyBonus){var e=creepyCrateBonusArray.findIndex(function(e){return e.id===a.id&&e.quality===a.quality});if(12==a.quality||null!=a.killstreak&&null===a.killstreak.sheen)w.crates[crateOrder[currentCrate]][currentCrateObj.loot.length+e].n++;else if(null===a.killstreak.killstreaker){var r=!1,t=!0,s=!1,n=void 0;try{for(var u,o=w.crates[crateOrder[currentCrate]][currentCrateObj.loot.length+e].s[Symbol.iterator]();!(t=(u=o.next()).done);t=!0){var l=u.value;if(l.s===a.killstreak.sheen){l.n+=1,r=!0;break}}}catch(e){s=!0,n=e}finally{try{t||null==o.return||o.return()}finally{if(s)throw n}}r||w.crates[crateOrder[currentCrate]][currentCrateObj.loot.length+e].s.push({n:1,s:a.killstreak.sheen})}else{var c=!1,i=!0,h=!1,d=void 0;try{for(var f,b=w.crates[crateOrder[currentCrate]][currentCrateObj.loot.length+e].p[Symbol.iterator]();!(i=(f=b.next()).done);i=!0){var v=f.value;if(v.s===a.killstreak.sheen&&v.p===a.killstreak.killstreaker){v.n+=1,c=!0;break}}}catch(e){h=!0,d=e}finally{try{i||null==b.return||b.return()}finally{if(h)throw d}}c||w.crates[crateOrder[currentCrate]][currentCrateObj.loot.length+e].p.push({n:1,s:a.killstreak.sheen,k:a.killstreak.killstreaker})}}else if(770!=a.id){var k=!1,y=!0,g=!1,m=void 0;try{for(var p,x=w.bonusItems[Symbol.iterator]();!(y=(p=x.next()).done);y=!0){var M=p.value;if(M.i===a.id){M.n++,k=!0;break}}}catch(e){g=!0,m=e}finally{try{y||null==x.return||x.return()}finally{if(g)throw m}}k||w.bonusItems.push({i:a.id,n:1})}}()}catch(e){y=!0,g=e}finally{try{k||null==m.return||m.return()}finally{if(y)throw g}}return a&&(localStorage.setItem("unboxertf-crates",JSON.stringify(save.crates)),localStorage.setItem("unboxertf-bonusitems",JSON.stringify(save.bonusItems))),r}function addToUnusuals(e,a,r){e.quality.includes("unusual")&&(["strange","strangeunusual","unusualstrange"].includes(e.quality)?a.unusuals.push([e.id,e.effect,1,e.wear]):a.unusuals.push([e.id,e.effect,0,e.wear]),r&&updateUnusualStats(save.unusuals[save.unusuals.length-1],!0));var t=!0,s=!1,n=void 0;try{for(var u,o=e.bonus[Symbol.iterator]();!(t=(u=o.next()).done);t=!0){var l=u.value;770===l.id&&(a.unusuals.push([l.id,l.taunt,0,0]),r&&updateUnusualStats(save.unusuals[save.unusuals.length-1],!0))}}catch(e){s=!0,n=e}finally{try{t||null==o.return||o.return()}finally{if(s)throw n}}r&&localStorage.setItem("unboxertf-unusuals",JSON.stringify(save.unusuals))}function addToStats(e,a,r){switch(a.stats["crates-opened"]+=1,a.stats["keys-money"]=(parseFloat(a.stats["keys-money"])+2.49).toFixed(2),e.quality){case"unique":a.stats["unique-unboxed"]+=1;break;case"strange":a.stats["strange-unboxed"]+=1;break;case"haunted":a.stats["haunted-unboxed"]+=1;break;case"unusual":case"unusualunique":a.stats["unusual-unboxed"]+=1;break;case"strangehaunted":a.stats["strange-unboxed"]+=1,a.stats["haunted-unboxed"]+=1,a.stats["strangehaunted-unboxed"]+=1;break;case"strangeunusual":case"unusualstrange":a.stats["strange-unboxed"]+=1,a.stats["unusual-unboxed"]+=1,a.stats["strangeunusual-unboxed"]+=1}switch(e.wear&&(a.stats["decorated-unboxed"]+=1),e.grade&&(a.stats["grade-unboxed"]+=1),e.grade){case 1:a.stats["civilian-unboxed"]+=1;break;case 2:a.stats["freelance-unboxed"]+=1;break;case 3:a.stats["mercenary-unboxed"]+=1;break;case 4:a.stats["commando-unboxed"]+=1;break;case 5:a.stats["assassin-unboxed"]+=1;break;case 6:a.stats["elite-unboxed"]+=1}switch(e.wear){case 1:a.stats["factorynew-unboxed"]+=1;break;case 2:a.stats["minimalwear-unboxed"]+=1;break;case 3:a.stats["fieldtested-unboxed"]+=1;break;case 4:a.stats["wellworn-unboxed"]+=1;break;case 5:a.stats["battlescarred-unboxed"]+=1}if(["unusual","unusualunique","strangeunusual","unusualstrange"].includes(e.quality)){(a.stats["unboxes-since-last-unusual"]<a.stats["min-unusual-drought"]||"N/A"===a.stats["min-unusual-drought"])&&(a.stats["min-unusual-drought"]=a.stats["unboxes-since-last-unusual"]),a.crateStats[crateOrder[currentCrate]].u++,a.stats["unusual-avg-array"].push(a.stats["unboxes-since-last-unusual"]);var t=0,s=!0,n=!1,u=void 0;try{for(var o,l=a.stats["unusual-avg-array"][Symbol.iterator]();!(s=(o=l.next()).done);s=!0){var c=o.value;t+=parseInt(c)}}catch(e){n=!0,u=e}finally{try{s||null==l.return||l.return()}finally{if(n)throw u}}a.stats["unusual-avg"]=Math.round(t/a.stats["unusual-avg-array"].length),a.stats["unusual-avgprice-array"].push((2.49*a.stats["unboxes-since-last-unusual"]).toFixed(2));var i=!(t=0),h=!1,d=void 0;try{for(var f,b=a.stats["unusual-avgprice-array"][Symbol.iterator]();!(i=(f=b.next()).done);i=!0){var v=f.value;t+=parseFloat(v)}}catch(e){h=!0,d=e}finally{try{i||null==b.return||b.return()}finally{if(h)throw d}}a.stats["unusual-avgprice"]=(t/a.stats["unusual-avg-array"].length).toFixed(2),a.stats["unboxes-since-last-unusual"]=0}else currentCrateObj.unusual&&(a.stats["unboxes-since-last-unusual"]+=1,a.stats["unboxes-since-last-unusual"]>a.stats["max-unusual-drought"]&&(a.stats["max-unusual-drought"]=a.stats["unboxes-since-last-unusual"]));if(a.stats["bonus-unboxed"]+=e.bonus.length,currentCrateObj.unusual&&(a.stats["unusual-chances"]+=1),crateHasRandomStranges(currentCrateObj)&&(a.stats["strange-chances"]+=1,e.quality.includes("strange")&&(a.stats["random-strange-unboxed"]+=1)),a.crateStats[crateOrder[currentCrate]].n++,0<e.bonus.length)switch(a.crateStats[crateOrder[currentCrate]].b+=e.bonus.length,e.bonus.length){case 1:a.stats["single-bonus-unboxed"]++;break;case 2:a.stats["double-bonus-unboxed"]++;break;case 3:a.stats["triple-bonus-unboxed"]++}var k=!0,y=!1,g=void 0;try{for(var m,p=e.bonus[Symbol.iterator]();!(k=(m=p.next()).done);k=!0){770===m.value.id&&(a.crateStats[crateOrder[currentCrate]].u++,a.stats["unusualifiers-unboxed"]++)}}catch(e){y=!0,g=e}finally{try{k||null==p.return||p.return()}finally{if(y)throw g}}r&&(localStorage.setItem("unboxertf-cratestats",JSON.stringify(save.crateStats)),localStorage.setItem("unboxertf-stats",JSON.stringify(save.stats)))}self.onmessage=function(e){if(null!=e.data.crate){var a=e.data.bulkSave;save.options=JSON.parse(e.data.options),currentCrate=e.data.crate,currentCrateObj=cA[crateOrder[currentCrate]];for(var r=0;r<e.data.crateNum;){var t=unbox();e.data.cheats||self.postMessage({item:t}),addToInventory(t,a),addToUnusuals(t,a),addToStats(t,a),++r%1e3==0&&self.postMessage({progress:r})}self.postMessage({complete:!0,bulkSave:JSON.stringify(a)})}};