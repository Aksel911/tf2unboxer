let currentCrateObj,currentCrate=0,save={options:{}};importScripts("../data/crate.js");const wearTable=["","FN","MW","FT","WW","BS"],wearTableNames=["",80,81,82,83,84],gradeTable=["","colorcivilian","colorfreelance","colormercenary","colorcommando","colorassassin","colorelite"],sheenTable=["",128,129,130,131,132,133,134],killstreakerTable=["",135,136,137,138,139,140,141];function crateHasRandomStranges(a){let b=!1;for(let c of a.loot)if([4,6,8,9,10].includes(c.quality)){b=!0;break}return b}function getString(){return null}function reportError(a){self.postMessage({error:a})}function unbox(){let a,b,c,d,e,f,g,h,i=[];try{const j=currentCrateObj;a=Math.floor(1e4*Math.random()+1),b=Math.floor(150*Math.random()+1);let k,l=0;if(j.unusual&&(1===b||save.options.forceUnusual)){let a=[];switch(j.unusual){case 1:a=unusualPool.slice(),96===currentCrate&&save.options.eotlGlitch&&a.push(916,917,918);;1<=currentCrateObj.series&&55>=currentCrateObj.series&&save.options.sniperVsSpyUnusuals&&a.push(1354,1359,1370,62,158,194,124,70,178),c=a[Math.floor(Math.random()*a.length)],k={id:c,quality:null};break;case 2:let b;for(save.options.forceGrade?b=save.options.forceGradeNum:(b=Math.floor(1e3*Math.random()+1),b=8>=b?6:40>=b?5:200>=b?4:3);0===a.length;){if(a=j.loot.filter(a=>[6,7,9,10].includes(a.quality)&&a.grade==b),2>=b)throw new Error;b--}k=a[Math.floor(Math.random()*a.length)],c=k.id;break;case 3:a=j.loot.filter(a=>[6,7,9,10].includes(a.quality)),k=a[Math.floor(Math.random()*a.length)],c=k.id;}i.push("unusual")}else switch(j.autoChance){case 1:let b;save.options.forceGrade?b=save.options.forceGradeNum:(b=Math.floor(1e3*Math.random()+1),b=8>=b?6:40>=b?5:200>=b?4:3,1===j.loot[0].grade&&(b-=2));let c=[];for(;0===c.length;){if(c=j.loot.filter(a=>a.grade==b),0>=b)throw new Error;b--}let d=Math.floor(Math.random()*c.length);k=c[d],h=j.loot.findIndex(a=>a.id==k.id);break;case 2:let e=Math.floor(Math.random()*j.loot.length);k=j.loot[e],h=e;break;default:for(const b in a=Math.floor(9900*Math.random()+1),j.loot)if(a>l&&a<=l+j.loot[b].chance){k=j.loot[b],h=b;break}else l+=j.loot[b].chance;;}c=k.id;let m=!1;if(null!=k.quality){let a;switch(k.quality){case 0:i.push("unusual");break;case 1:case 7:i.push("unique");break;case 2:i.push("strange");break;case 3:i.push("haunted");break;case 4:case 9:case 10:a=Math.floor(10*Math.random()+1),10==a||save.options.forceStrange?i.push("strange"):i.push("unique");break;case 5:m=!0;break;case 6:m=!0,a=Math.floor(10*Math.random()+1),(10==a||save.options.forceStrange)&&i.push("strange");;break;case 8:a=Math.floor(10*Math.random()+1),10==a||save.options.forceStrange?i.push("strange","haunted"):i.push("unique");break;case 11:i.push("unique"),f={sheen:null,killstreaker:null},a=Math.floor(100*Math.random()+1),(65<a||save.options.forceProKit)&&(f.sheen=Math.floor(Math.random()*(sheenTable.length-1)+1)),(90<a||save.options.forceProKit)&&(f.killstreaker=Math.floor(Math.random()*(killstreakerTable.length-1)+1));break;case 12:i.push("strangifier");}}if(i=1===i.length?i[0]:i.join(""),d=0,m){let a=Math.floor(10*Math.random()+1);1===a?d=1:2===a||3===a?d=2:4===a||5===a||6===a||7===a?d=3:8===a||9===a?d=4:10===a?d=5:void 0}if(e=0,i.includes("unusual")){let a;if(!["none",null,void 0].includes(save.options.halloweenMode)&&halloweenModeCrateList[save.options.halloweenMode].includes(currentCrate))switch(save.options.halloweenMode){case"hw11":a=hw11FX;break;case"hw12":a=hw12FX;break;case"hw13":a=hw13FX;break;case"hw14":a=hw14FX;break;case"hw16":a=hw16FX;break;case"hw17":a=hw17FX;break;case"hw18":a=hw18FX;break;case"hw19":a=hw19FX;break;case"hw20":a=hw20FX;break;case"xmas19":a=xmas19FX;break;case"xmas20":a=xmas20FX;}else a=j.effects;e=a[Math.floor(Math.random()*a.length)]}if(g=[],j.bonus){let a=0;if(save.options.forceBonusItem)a=3;else{a=0;let b=Math.floor(5*Math.random()+1);(2>=b||save.options.forceBonusItem)&&(a++,b=Math.floor(5*Math.random()+1),1==b&&(a++,b=Math.floor(25*Math.random()+1),1==b&&a++))}for(;0<a;a--){let a=Math.floor(1e3*Math.random()+1);if(15>=a||save.options.forceUnusualifier){let a=Math.floor(Math.random()*unusualifierArray.length);g.push({id:770,taunt:unusualifierArray[a]})}else{let a=!1;if(j.exclusiveBonus){let b=Math.floor(1e4*Math.random()+1);b<=j.exclusiveBonus.chance&&(a=!0)}if(a){let a=Math.floor(Math.random()*j.exclusiveBonus.loot.length);g.push({id:j.exclusiveBonus.loot[a]})}else{let a=Math.floor(Math.random()*globalBonusItemArray.length);switch(globalBonusItemArray[a]){case"paint":g.push({id:paintBonusArray[Math.floor(Math.random()*paintBonusArray.length)]});break;case"strangepart":g.push({id:strangePartBonusArray[Math.floor(Math.random()*strangePartBonusArray.length)]});break;default:g.push({id:globalBonusItemArray[a]});}}}}}else if(j.exclusiveBonus){let a=Math.floor(1e4*Math.random()+1);if(a<=j.exclusiveBonus.chance||save.options.forceBonusItem){let a=Math.floor(Math.random()*j.exclusiveBonus.loot.length);g.push({id:j.exclusiveBonus.loot[a]})}}if(j.creepyBonus){let a=Math.floor(50*Math.random()+1);if(1===a||save.options.forceBonusItem){let a,b=Math.floor(Math.random()*creepyCrateBonusArray.length);if(11===creepyCrateBonusArray[b].quality){a={sheen:null,killstreaker:null};let b=Math.floor(100*Math.random()+1);(65<b||save.options.forceProKit)&&(a.sheen=Math.floor(Math.random()*(sheenTable.length-1)+1)),(90<b||save.options.forceProKit)&&(a.killstreaker=Math.floor(Math.random()*(killstreakerTable.length-1)+1))}g.push({id:creepyCrateBonusArray[b].id,quality:creepyCrateBonusArray[b].quality,killstreak:a})}}return{id:c,cratePos:h,name:getString("item",c),quality:i,wear:d,grade:k.grade,effect:e,killstreak:f,bonus:g}}catch(f){let g=`Something went wrong when executing unbox().
    Error stack: ${f.stack}

    currentCrate: ${currentCrate}
    randomNumber: ${a}
    unusualRandomNumber: ${b}
    forceUnusual: ${save.options.forceUnusual}
    itemId: ${c}
    quality: ${i}
    wear: ${d}
    effect: ${e}`;console.error(g),reportError(g)}}function addToInventory(a,b,c){let d;if(null!=a.cratePos)switch(currentCrateObj.loot[a.cratePos].quality){case 4:case 8:case 9:case 10:d=["strange","strangehaunted"].includes(a.quality)?b.crates[crateOrder[currentCrate]][a.cratePos].q+=1:b.crates[crateOrder[currentCrate]][a.cratePos].n+=1;break;case 5:d=b.crates[crateOrder[currentCrate]][a.cratePos][wearTable[a.wear]]+=1;break;case 6:d="strange"===a.quality?b.crates[crateOrder[currentCrate]][a.cratePos][`${wearTable[a.wear]}q`]+=1:b.crates[crateOrder[currentCrate]][a.cratePos][wearTable[a.wear]]+=1;break;case 11:let c=!1;if(a.killstreak.killstreaker){for(let e of b.crates[crateOrder[currentCrate]][a.cratePos].p)if(e.s===a.killstreak.sheen&&e.p===a.killstreak.killstreaker){d=e.n+=1,c=!0;break}c||(d=1,b.crates[crateOrder[currentCrate]][a.cratePos].p.push({n:1,s:a.killstreak.sheen,k:a.killstreak.killstreaker}))}else if(a.killstreak.sheen){for(let e of b.crates[crateOrder[currentCrate]][a.cratePos].s)if(e.s===a.killstreak.sheen){d=e.n+=1,c=!0;break}c||(d=1,b.crates[crateOrder[currentCrate]][a.cratePos].s.push({n:1,s:a.killstreak.sheen}))}else d=b.crates[crateOrder[currentCrate]][a.cratePos].n+=1;break;default:d=b.crates[crateOrder[currentCrate]][a.cratePos].n+=1;}for(let d of a.bonus)if(null!=currentCrateObj.exclusiveBonus.loot&&currentCrateObj.exclusiveBonus.loot.includes(d.id))b.crates[crateOrder[currentCrate]][currentCrateObj.loot.length+currentCrateObj.exclusiveBonus.loot.findIndex(a=>a===d.id)].n++;else if(currentCrateObj.creepyBonus){let a=creepyCrateBonusArray.findIndex(a=>a.id===d.id&&a.quality===d.quality);if(12==d.quality||null!=d.killstreak&&null===d.killstreak.sheen)b.crates[crateOrder[currentCrate]][currentCrateObj.loot.length+a].n++;else if(null===d.killstreak.killstreaker){let c=!1;for(let e of b.crates[crateOrder[currentCrate]][currentCrateObj.loot.length+a].s)if(e.s===d.killstreak.sheen){e.n+=1,c=!0;break}c||b.crates[crateOrder[currentCrate]][currentCrateObj.loot.length+a].s.push({n:1,s:d.killstreak.sheen})}else{let c=!1;for(let e of b.crates[crateOrder[currentCrate]][currentCrateObj.loot.length+a].p)if(e.s===d.killstreak.sheen&&e.p===d.killstreak.killstreaker){e.n+=1,c=!0;break}c||b.crates[crateOrder[currentCrate]][currentCrateObj.loot.length+a].p.push({n:1,s:d.killstreak.sheen,k:d.killstreak.killstreaker})}}else if(770!=d.id){let a=!1;for(let c of b.bonusItems)if(c.i===d.id){c.n++,a=!0;break}a||b.bonusItems.push({i:d.id,n:1})}return c&&(localStorage.setItem("unboxertf-crates",JSON.stringify(save.crates)),localStorage.setItem("unboxertf-bonusitems",JSON.stringify(save.bonusItems))),d}function addToUnusuals(a,b,c){a.quality.includes("unusual")&&(["strange","strangeunusual","unusualstrange"].includes(a.quality)?b.unusuals.push([a.id,a.effect,1,a.wear]):b.unusuals.push([a.id,a.effect,0,a.wear]),c&&updateUnusualStats(save.unusuals[save.unusuals.length-1],!0));for(let d of a.bonus)770===d.id&&(b.unusuals.push([d.id,d.taunt,0,0]),c&&updateUnusualStats(save.unusuals[save.unusuals.length-1],!0));c&&localStorage.setItem("unboxertf-unusuals",JSON.stringify(save.unusuals))}function addToStats(a,b,c){switch(b.stats["crates-opened"]+=1,b.stats["keys-money"]=(parseFloat(b.stats["keys-money"])+2.49).toFixed(2),a.quality){case"unique":b.stats["unique-unboxed"]+=1;break;case"strange":b.stats["strange-unboxed"]+=1;break;case"haunted":b.stats["haunted-unboxed"]+=1;break;case"unusual":case"unusualunique":b.stats["unusual-unboxed"]+=1;break;case"strangehaunted":b.stats["strange-unboxed"]+=1,b.stats["haunted-unboxed"]+=1,b.stats["strangehaunted-unboxed"]+=1;break;case"strangeunusual":case"unusualstrange":b.stats["strange-unboxed"]+=1,b.stats["unusual-unboxed"]+=1,b.stats["strangeunusual-unboxed"]+=1;}switch(a.wear&&(b.stats["decorated-unboxed"]+=1),a.grade&&(b.stats["grade-unboxed"]+=1),a.grade){case 1:b.stats["civilian-unboxed"]+=1;break;case 2:b.stats["freelance-unboxed"]+=1;break;case 3:b.stats["mercenary-unboxed"]+=1;break;case 4:b.stats["commando-unboxed"]+=1;break;case 5:b.stats["assassin-unboxed"]+=1;break;case 6:b.stats["elite-unboxed"]+=1;}switch(a.wear){case 1:b.stats["factorynew-unboxed"]+=1;break;case 2:b.stats["minimalwear-unboxed"]+=1;break;case 3:b.stats["fieldtested-unboxed"]+=1;break;case 4:b.stats["wellworn-unboxed"]+=1;break;case 5:b.stats["battlescarred-unboxed"]+=1;}if(["unusual","unusualunique","strangeunusual","unusualstrange"].includes(a.quality)){(b.stats["unboxes-since-last-unusual"]<b.stats["min-unusual-drought"]||"N/A"===b.stats["min-unusual-drought"])&&(b.stats["min-unusual-drought"]=b.stats["unboxes-since-last-unusual"]),b.crateStats[crateOrder[currentCrate]].u++,b.stats["unusual-avg-array"].push(b.stats["unboxes-since-last-unusual"]);let a=0;for(let c of b.stats["unusual-avg-array"])a+=parseInt(c);b.stats["unusual-avg"]=Math.round(a/b.stats["unusual-avg-array"].length),b.stats["unusual-avgprice-array"].push((2.49*b.stats["unboxes-since-last-unusual"]).toFixed(2)),a=0;for(let c of b.stats["unusual-avgprice-array"])a+=parseFloat(c);b.stats["unusual-avgprice"]=(a/b.stats["unusual-avg-array"].length).toFixed(2),b.stats["unboxes-since-last-unusual"]=0}else currentCrateObj.unusual&&(b.stats["unboxes-since-last-unusual"]+=1,b.stats["unboxes-since-last-unusual"]>b.stats["max-unusual-drought"]&&(b.stats["max-unusual-drought"]=b.stats["unboxes-since-last-unusual"]));if(b.stats["bonus-unboxed"]+=a.bonus.length,currentCrateObj.unusual&&(b.stats["unusual-chances"]+=1),crateHasRandomStranges(currentCrateObj)&&(b.stats["strange-chances"]+=1,a.quality.includes("strange")&&(b.stats["random-strange-unboxed"]+=1)),(b.crateStats[crateOrder[currentCrate]].n++,0<a.bonus.length))switch(b.crateStats[crateOrder[currentCrate]].b+=a.bonus.length,a.bonus.length){case 1:b.stats["single-bonus-unboxed"]++;break;case 2:b.stats["double-bonus-unboxed"]++;break;case 3:b.stats["triple-bonus-unboxed"]++;}for(let d of a.bonus)770===d.id&&(b.crateStats[crateOrder[currentCrate]].u++,b.stats["unusualifiers-unboxed"]++);c&&(localStorage.setItem("unboxertf-cratestats",JSON.stringify(save.crateStats)),localStorage.setItem("unboxertf-stats",JSON.stringify(save.stats)))}self.onmessage=function(a){if(a.data.crate!=null){let b=a.data.bulkSave;save.options=JSON.parse(a.data.options),currentCrate=a.data.crate,currentCrateObj=cA[crateOrder[currentCrate]];for(let c=0;c<a.data.crateNum;){let d=unbox();a.data.cheats||self.postMessage({item:d}),addToInventory(d,b),addToUnusuals(d,b),addToStats(d,b),c++,0==c%1e3&&self.postMessage({progress:c})}self.postMessage({complete:!0,bulkSave:JSON.stringify(b)})}};